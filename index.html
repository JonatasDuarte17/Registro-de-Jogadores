<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Registro de Jogadores</title>
    
    <!-- Firebase SDK (versão de compatibilidade) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <!-- QR Code Scanner -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                    }
                }
            }
        }
    </script>
    
    <!-- Configuração do Firebase -->
    <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDq-L2doBOPRULBPcoBz6fSHvnPxxLnH4E",
      authDomain: "registro-de-jogadores.firebaseapp.com",
      databaseURL: "https://registro-de-jogadores-default-rtdb.firebaseio.com",
      projectId: "registro-de-jogadores",
      storageBucket: "registro-de-jogadores.firebasestorage.app",
      messagingSenderId: "86121414534",
      appId: "1:86121414534:web:c1d838067e44ec905d3607",
      measurementId: "G-3Z698CFG29"
    };

    // Inicializar Firebase
    firebase.initializeApp(firebaseConfig);
    </script>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-800 dark:text-gray-200 min-h-screen">
    <!-- Dark mode detection -->
    <script>
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
    </script>

    <!-- Login Screen -->
    <div id="login-screen" class="fixed inset-0 bg-white dark:bg-gray-900 z-50 flex items-center justify-center p-4">
        <div class="bg-gray-100 dark:bg-gray-800 rounded-lg p-6 w-full max-w-md shadow-lg">
            <h2 class="text-2xl font-bold text-center text-primary mb-6">Sistema de Registro de Jogadores</h2>
            
            <div id="login-error" class="mb-4 bg-red-100 text-red-800 p-3 rounded hidden">
                Usuário ou senha incorretos. Tente novamente.
            </div>
            
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="username" class="block text-sm font-medium mb-1">Usuário</label>
                    <input type="text" id="username" class="w-full rounded-md border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-700 text-base px-3 py-2" required>
                </div>
                
                <div>
                    <label for="password" class="block text-sm font-medium mb-1">Senha</label>
                    <input type="password" id="password" class="w-full rounded-md border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-700 text-base px-3 py-2" required>
                </div>
                
                <div class="pt-2">
                    <button type="submit" class="w-full bg-primary hover:bg-opacity-90 text-white font-bold py-2 px-4 rounded">
                        Entrar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Notification system -->
    <div id="notification" class="fixed top-4 right-4 max-w-xs bg-white dark:bg-gray-800 border-l-4 border-primary shadow-md rounded-md p-4 transform transition-transform duration-300 translate-x-full z-50">
        <div class="flex items-start">
            <div class="ml-3 w-0 flex-1">
                <p id="notification-message" class="text-sm font-medium text-gray-900 dark:text-gray-100"></p>
            </div>
            <div class="ml-4 flex-shrink-0 flex">
                <button id="close-notification" class="inline-flex text-gray-400 hover:text-gray-500 focus:outline-none">
                    <span class="sr-only">Fechar</span>
                    <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Sync indicator -->
    <div id="sync-indicator" class="fixed bottom-4 right-4 bg-white dark:bg-gray-800 shadow-md rounded-full p-2 flex items-center space-x-2 text-sm z-50 opacity-0 transition-opacity duration-300">
        <div class="w-3 h-3 rounded-full bg-yellow-400" id="sync-status"></div>
        <span id="sync-text">Sincronizando...</span>
    </div>
    <div class="container mx-auto px-4 py-6 max-w-3xl">
        <!-- User header -->
        <div class="flex justify-between items-center mb-4">
            <div class="user-info text-sm">
                Logado como: <span id="current-user" class="font-semibold"></span>
                <span id="admin-badge" class="ml-2 bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200 px-2 py-0.5 rounded-full text-xs hidden">Admin</span>
            </div>
            <button id="logout-button" class="text-sm text-gray-600 dark:text-gray-400 hover:text-primary">
                Sair
            </button>
        </div>
        
        <h1 class="text-3xl font-bold text-center text-primary mb-6">Sistema de Registro de Jogadores</h1>
        
        <!-- Tabs -->
        <div class="mb-6">
            <div class="flex border-b border-gray-300 dark:border-gray-700">
                <button id="tab-id-input" class="tab-btn px-4 py-2 border-b-2 border-primary font-medium text-primary">Entrada de ID</button>
                <button id="tab-register" class="tab-btn px-4 py-2 border-b-2 border-transparent font-medium text-gray-500 dark:text-gray-400 hover:text-primary dark:hover:text-primary">Cadastro</button>
                <button id="tab-search" class="tab-btn px-4 py-2 border-b-2 border-transparent font-medium text-gray-500 dark:text-gray-400 hover:text-primary dark:hover:text-primary">Pesquisa</button>
            </div>
        </div>
        <!-- Content containers -->
        <div id="id-input-container" class="tab-content">
            <div class="bg-gray-100 dark:bg-gray-800 rounded-lg p-4 mb-4">
                <h2 class="text-xl font-semibold mb-2">Verificar Jogador</h2>
                <p class="mb-4">Escaneie o QR Code ou digite o ID do jogador para verificar seu status.</p>
                
                <div class="flex flex-col items-center">
                    <!-- Container da câmera -->
                    <div id="video-container" class="relative mb-4 w-full max-w-md hidden">
                        <video id="video" class="rounded-lg w-full shadow-lg"></video>
                        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 border-2 border-primary rounded w-2/3 h-2/3 pointer-events-none"></div>
                    </div>
                    
                    <!-- Botões da câmera -->
                    <div class="mb-4 flex space-x-2">
                        <button id="startButton" class="bg-primary hover:bg-opacity-90 text-white font-bold py-2 px-4 rounded">
                            Escanear QR Code
                        </button>
                        <button id="stopButton" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded hidden">
                            Parar Câmera
                        </button>
                    </div>
                    
                    <!-- Campo de entrada manual -->
                    <div class="w-full max-w-md mb-4">
                        <p class="text-center text-sm mb-2">Ou digite o ID manualmente:</p>
                        <div class="flex space-x-2">
                            <input type="text" id="playerIdInput" class="w-full rounded-md border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-700 text-base px-3 py-2" placeholder="Digite o ID do jogador">
                            <button id="checkPlayerButton" class="bg-primary hover:bg-opacity-90 text-white px-3 py-2 rounded whitespace-nowrap">
                                Verificar
                            </button>
                        </div>
                    </div>
                    
                    <div class="w-full max-w-md">
                        <div class="bg-white dark:bg-gray-700 p-4 rounded-lg border border-gray-200 dark:border-gray-600 mb-4">
                            <h3 class="font-medium text-lg mb-2">IDs de exemplo</h3>
                            <p class="text-sm mb-1">Para teste, você pode usar os seguintes IDs:</p>
                            <ul class="list-disc list-inside text-sm">
                                <li>123456 - João Silva (Liberado)</li>
                                <li>789012 - Maria Oliveira (Bloqueado)</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="player-info-display" class="mt-4 bg-white dark:bg-gray-800 p-4 rounded-lg shadow hidden">
                <h3 class="text-lg font-semibold border-b pb-2 mb-2 border-gray-200 dark:border-gray-700">Informações do Jogador</h3>
                <div id="player-info" class="space-y-2">
                    <!-- Player information will be displayed here -->
                </div>
            </div>
        </div>
        <div id="register-container" class="tab-content hidden">
            <div class="bg-gray-100 dark:bg-gray-800 rounded-lg p-4">
                <h2 class="text-xl font-semibold mb-4">Cadastro de Jogador</h2>
                <form id="register-form" class="space-y-4">
                    <div>
                        <label for="playerId" class="block text-sm font-medium mb-1">ID do Jogador</label>
                        <input type="text" id="playerId" class="w-full rounded-md border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-700 text-base px-3 py-2" placeholder="Digite o ID do jogador" required>
                    </div>
                    
                    <div>
                        <label for="playerName" class="block text-sm font-medium mb-1">Nome do Jogador</label>
                        <input type="text" id="playerName" class="w-full rounded-md border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-700 text-base px-3 py-2" required>
                    </div>
                    
                    <div>
                        <label for="playerAge" class="block text-sm font-medium mb-1">Idade</label>
                        <input type="number" id="playerAge" min="1" max="120" class="w-full rounded-md border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-700 text-base px-3 py-2" required>
                    </div>
                    
                    <div>
                        <label for="playerTeam" class="block text-sm font-medium mb-1">Time</label>
                        <input type="text" id="playerTeam" class="w-full rounded-md border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-700 text-base px-3 py-2" required>
                    </div>
                    
                    <div>
                        <label for="playerStatus" class="block text-sm font-medium mb-1">Status</label>
                        <select id="playerStatus" class="w-full rounded-md border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-700 text-base px-3 py-2" required>
                            <option value="liberado">Liberado para jogar</option>
                            <option value="bloqueado">Não liberado para jogar</option>
                        </select>
                    </div>
                    
                    <div class="pt-2">
                        <button type="submit" class="w-full bg-primary hover:bg-opacity-90 text-white font-bold py-2 px-4 rounded">
                            Cadastrar Jogador
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <div id="search-container" class="tab-content hidden">
            <div class="bg-gray-100 dark:bg-gray-800 rounded-lg p-4">
                <h2 class="text-xl font-semibold mb-4">Pesquisar Jogador</h2>
                <div class="mb-4">
                    <label for="searchTerm" class="block text-sm font-medium mb-1">Buscar por nome</label>
                    <div class="flex space-x-2">
                        <input type="text" id="searchTerm" class="w-full rounded-md border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-700 text-base px-3 py-2" placeholder="Digite o nome do jogador">
                        <button id="searchButton" class="bg-primary hover:bg-opacity-90 text-white px-3 py-2 rounded">
                            Buscar
                        </button>
                    </div>
                </div>
                
                <div id="search-results" class="mt-4">
                    <h3 class="text-lg font-semibold mb-2 hidden" id="results-heading">Resultados da Busca</h3>
                    <div id="players-list" class="space-y-2">
                        <!-- Search results will be displayed here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        // In-memory database
        let playersDB = [];
        
        // User management
        let currentUser = null;
        let isAdmin = false;
        
        // Predefined users (will be stored in Firebase)
        const users = [
            { username: "admin", password: "admin123", isAdmin: true },
            { username: "mesario1", password: "mesario123", isAdmin: false },
            { username: "mesario2", password: "mesario123", isAdmin: false }
        ];
        
        // DOM elements
        const playerInfoDisplay = document.getElementById('player-info-display');
        const playerInfo = document.getElementById('player-info');
        const registerForm = document.getElementById('register-form');
        const searchButton = document.getElementById('searchButton');
        const searchTerm = document.getElementById('searchTerm');
        const playersListDiv = document.getElementById('players-list');
        const resultsHeading = document.getElementById('results-heading');
        const playerIdInput = document.getElementById('playerIdInput');
        const checkPlayerButton = document.getElementById('checkPlayerButton');
        const notification = document.getElementById('notification');
        const notificationMessage = document.getElementById('notification-message');
        const closeNotification = document.getElementById('close-notification');
        
        // Login screen elements
        const loginScreen = document.getElementById('login-screen');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const currentUserSpan = document.getElementById('current-user');
        const adminBadge = document.getElementById('admin-badge');
        const logoutButton = document.getElementById('logout-button');
        
        // Tab elements
        const tabIdInput = document.getElementById('tab-id-input');
        const tabRegister = document.getElementById('tab-register');
        const tabSearch = document.getElementById('tab-search');
        const idInputContainer = document.getElementById('id-input-container');
        const registerContainer = document.getElementById('register-container');
        const searchContainer = document.getElementById('search-container');
        
        // Camera elements
        const video = document.getElementById('video');
        const videoContainer = document.getElementById('video-container');
        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');
        
        // Sync indicator elements
        const syncIndicator = document.getElementById('sync-indicator');
        const syncStatus = document.getElementById('sync-status');
        const syncText = document.getElementById('sync-text');
        
        // Camera variables
        let videoStream = null;
        let isScanning = false;
        let scanInterval = null;
        let canvasElement = document.createElement('canvas');
        let canvas = canvasElement.getContext('2d');
        // Initialize database from Firebase
        function initializeDB() {
            const dbRef = firebase.database().ref('players');
            
            // Check if data exists first time
            dbRef.once('value')
                .then((snapshot) => {
                    if (!snapshot.exists()) {
                        console.log('Inicializando banco de dados de jogadores no Firebase');
                        
                        // Add sample data
                        const initialData = [
                            { id: '123456', name: 'João Silva', age: 25, team: 'Leões FC', status: 'liberado' },
                            { id: '789012', name: 'Maria Oliveira', age: 22, team: 'Tigres FC', status: 'bloqueado' }
                        ];
                        
                        // Save initial data to Firebase
                        const updates = {};
                        initialData.forEach(player => {
                            updates[player.id] = player;
                        });
                        
                        dbRef.update(updates)
                            .then(() => console.log('Dados iniciais salvos no Firebase'))
                            .catch(error => console.error('Erro ao salvar dados iniciais:', error));
                    } else {
                        console.log('Dados já existem no Firebase');
                    }
                })
                .catch(error => {
                    console.error('Erro ao verificar dados existentes:', error);
                });
            
            // Listen for changes
            dbRef.on('value', (snapshot) => {
                playersDB = [];
                if (snapshot.exists()) {
                    snapshot.forEach(childSnapshot => {
                        playersDB.push(childSnapshot.val());
                    });
                }
                console.log('Dados atualizados do Firebase:', playersDB.length, 'jogadores');
                
                // Refresh UI if on search screen with active search
                if (!searchContainer.classList.contains('hidden') && searchTerm.value.trim()) {
                    searchPlayers();
                }
            });
        }
        
        // Função para inicializar autenticação do Firebase
        function initializeFirebaseAuth() {
            // Verificar se usuários já existem no Firebase
            firebase.database().ref('users').once('value')
                .then((snapshot) => {
                    if (!snapshot.exists()) {
                        console.log('Inicializando usuários no Firebase');
                        
                        // Adicionar usuários predefinidos
                        const updates = {};
                        users.forEach(user => {
                            updates[user.username] = {
                                username: user.username,
                                password: user.password, // Em produção, NUNCA armazene senhas em texto plano
                                isAdmin: user.isAdmin
                            };
                        });
                        
                        firebase.database().ref('users').update(updates)
                            .then(() => console.log('Usuários iniciais salvos no Firebase'))
                            .catch(error => console.error('Erro ao salvar usuários iniciais:', error));
                    }
                })
                .catch(error => {
                    console.error('Erro ao verificar usuários existentes:', error);
                });
        }
        
        // Monitor connection state
        function monitorConnection() {
            const connectedRef = firebase.database().ref('.info/connected');
            connectedRef.on('value', (snap) => {
                if (snap.val() === true) {
                    syncStatus.classList.remove('bg-yellow-400', 'bg-red-500');
                    syncStatus.classList.add('bg-green-500');
                    syncText.textContent = 'Conectado';
                    syncIndicator.classList.remove('opacity-0');
                    setTimeout(() => {
                        syncIndicator.classList.add('opacity-0');
                    }, 3000);
                } else {
                    syncStatus.classList.remove('bg-green-500', 'bg-yellow-400');
                    syncStatus.classList.add('bg-red-500');
                    syncText.textContent = 'Desconectado';
                    syncIndicator.classList.remove('opacity-0');
                }
            });
            
            // Show syncing status
            const dbRef = firebase.database().ref('players');
            dbRef.on('child_changed', () => {
                syncStatus.classList.remove('bg-green-500', 'bg-red-500');
                syncStatus.classList.add('bg-yellow-400');
                syncText.textContent = 'Sincronizando...';
                syncIndicator.classList.remove('opacity-0');
                
                setTimeout(() => {
                    syncStatus.classList.remove('bg-yellow-400');
                    syncStatus.classList.add('bg-green-500');
                    syncText.textContent = 'Sincronizado';
                    
                    setTimeout(() => {
                        syncIndicator.classList.add('opacity-0');
                    }, 2000);
                }, 1000);
            });
        }
        
        // Check if user is already logged in
        function checkLoginStatus() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                try {
                    const user = JSON.parse(savedUser);
                    loginUser(user.username, user.isAdmin);
                } catch (e) {
                    console.error('Erro ao analisar usuário salvo:', e);
                    logoutUser();
                }
            }
        }
        
        // Atualizar função de verificação de login
        function attemptLogin(username, password) {
            return new Promise((resolve, reject) => {
                firebase.database().ref('users/' + username).once('value')
                    .then((snapshot) => {
                        if (snapshot.exists()) {
                            const userData = snapshot.val();
                            if (userData.password === password) {
                                resolve({
                                    username: userData.username,
                                    isAdmin: userData.isAdmin
                                });
                            } else {
                                reject(new Error('Senha incorreta'));
                            }
                        } else {
                            reject(new Error('Usuário não encontrado'));
                        }
                    })
                    .catch(error => {
                        console.error('Erro ao verificar login:', error);
                        reject(error);
                    });
            });
        }
        
        // Login user
        function loginUser(username, admin) {
            currentUser = username;
            isAdmin = admin;
            
            // Update UI
            currentUserSpan.textContent = username;
            if (admin) {
                adminBadge.classList.remove('hidden');
            } else {
                adminBadge.classList.add('hidden');
            }
            
            // Hide login screen
            loginScreen.classList.add('hidden');
            
            // Update UI based on permissions
            updateUIBasedOnPermissions();
            
            // Save login state
            localStorage.setItem('currentUser', JSON.stringify({ username, isAdmin: admin }));
        }
        
        // Logout user
        function logoutUser() {
            currentUser = null;
            isAdmin = false;
            
            // Show login screen
            loginScreen.classList.remove('hidden');
            
            // Clear login state
            localStorage.removeItem('currentUser');
        }
        
        // Update UI based on user permissions
        function updateUIBasedOnPermissions() {
            if (!isAdmin) {
                // Hide or disable admin-only features
                tabRegister.classList.add('hidden');
                
                // Remove edit and toggle buttons from search results
                document.querySelectorAll('.edit-player, .toggle-status').forEach(button => {
                    button.classList.add('hidden');
                });
                
                // Hide edit button in player info display
                const editDisplayedButton = document.getElementById('edit-displayed-player');
                if (editDisplayedButton) {
                    editDisplayedButton.classList.add('hidden');
                }
            } else {
                // Show admin features
                tabRegister.classList.remove('hidden');
            }
        }
        // Start the camera with the facing mode (environment = rear camera on mobile)
        async function startCamera() {
            try {
                const constraints = {
                    video: { facingMode: 'environment' }
                };
                
                videoStream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = videoStream;
                
                // Wait for video to be ready
                await new Promise(resolve => {
                    video.onloadedmetadata = () => {
                        resolve();
                    };
                });
                
                await video.play();
                
                // Set canvas dimensions to match video
                canvasElement.width = video.videoWidth;
                canvasElement.height = video.videoHeight;
                
                // Start scanning
                isScanning = true;
                startQRScanning();
                
                // Update UI
                videoContainer.classList.remove('hidden');
                startButton.classList.add('hidden');
                stopButton.classList.remove('hidden');
            } catch (error) {
                console.error('Error starting camera:', error);
                showNotification('Erro ao acessar a câmera. Verifique as permissões.');
            }
        }
        
        // Stop camera and scanning
        function stopCamera() {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
            
            isScanning = false;
            if (scanInterval) {
                clearInterval(scanInterval);
                scanInterval = null;
            }
            
            video.srcObject = null;
            
            // Update UI
            videoContainer.classList.add('hidden');
            startButton.classList.remove('hidden');
            stopButton.classList.add('hidden');
        }
        
        // Scan for QR codes
        function startQRScanning() {
            if (!isScanning) return;
            
            scanInterval = setInterval(() => {
                if (video.readyState === video.HAVE_ENOUGH_DATA) {
                    // Draw video frame to canvas
                    canvas.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
                    const imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
                    
                    try {
                        // Use ZXing for QR code detection
                        const code = jsQR(imageData.data, imageData.width, imageData.height, {
                            inversionAttempts: "dontInvert",
                        });
                        
                        if (code) {
                            console.log('QR code detected:', code.data);
                            
                            // Vibrate if supported
                            if (navigator.vibrate) {
                                navigator.vibrate(200);
                            }
                            
                            // Fill input with QR code data
                            playerIdInput.value = code.data;
                            
                            // Check player automatically
                            checkPlayer();
                            
                            // Stop camera after successful scan
                            stopCamera();
                        }
                    } catch (error) {
                        console.error('Error scanning QR code:', error);
                    }
                }
            }, 100);
        }
        // Show notification
        function showNotification(message, duration = 3000) {
            notificationMessage.textContent = message;
            notification.classList.remove('translate-x-full');
            
            // Auto-hide after duration
            setTimeout(() => {
                hideNotification();
            }, duration);
        }
        
        // Hide notification
        function hideNotification() {
            notification.classList.add('translate-x-full');
        }
        
        // Handle tab switching
        function switchTab(tabId) {
            // Hide all tab content
            idInputContainer.classList.add('hidden');
            registerContainer.classList.add('hidden');
            searchContainer.classList.add('hidden');
            
            // Reset tab button styles
            tabIdInput.classList.remove('border-primary', 'text-primary');
            tabIdInput.classList.add('border-transparent', 'text-gray-500');
            tabRegister.classList.remove('border-primary', 'text-primary');
            tabRegister.classList.add('border-transparent', 'text-gray-500');
            tabSearch.classList.remove('border-primary', 'text-primary');
            tabSearch.classList.add('border-transparent', 'text-gray-500');
            
            // Show selected tab and highlight its button
            if (tabId === 'id-input') {
                idInputContainer.classList.remove('hidden');
                tabIdInput.classList.remove('border-transparent', 'text-gray-500');
                tabIdInput.classList.add('border-primary', 'text-primary');
            } else if (tabId === 'register') {
                registerContainer.classList.remove('hidden');
                tabRegister.classList.remove('border-transparent', 'text-gray-500');
                tabRegister.classList.add('border-primary', 'text-primary');
            } else if (tabId === 'search') {
                searchContainer.classList.remove('hidden');
                tabSearch.classList.remove('border-transparent', 'text-gray-500');
                tabSearch.classList.add('border-primary', 'text-primary');
            }
        }
        
        // Check player by ID
        function checkPlayer() {
            const id = playerIdInput.value.trim();
            
            if (!id) {
                showNotification('Por favor, digite o ID do jogador.');
                return;
            }
            
            // Look up player by ID
            const player = playersDB.find(p => p.id === id);
            
            if (player) {
                displayPlayerInfo(player);
            } else {
                // New player - suggest registration
                playerInfo.innerHTML = `
                    <div class="text-center py-4">
                        <p class="mb-3">Jogador não encontrado. Deseja cadastrar?</p>
                        <button id="register-new-player" class="bg-primary hover:bg-opacity-90 text-white font-bold py-2 px-4 rounded ${isAdmin ? '' : 'hidden'}">
                            Cadastrar Novo Jogador
                        </button>
                        <p class="${isAdmin ? 'hidden' : ''}">Somente administradores podem cadastrar novos jogadores.</p>
                    </div>
                `;
                
                const registerNewButton = document.getElementById('register-new-player');
                if (registerNewButton) {
                    registerNewButton.addEventListener('click', () => {
                        document.getElementById('playerId').value = id;
                        switchTab('register');
                    });
                }
                
                playerInfoDisplay.classList.remove('hidden');
            }
        }
        
        // Display player information after checking
        function displayPlayerInfo(player) {
            const statusClass = player.status === 'liberado' 
                ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' 
                : 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200';
            
            const statusText = player.status === 'liberado' ? 'Liberado para jogar' : 'Não liberado para jogar';
            
            playerInfo.innerHTML = `
                <div class="grid grid-cols-3 gap-1">
                    <div class="font-medium">Nome:</div>
                    <div class="col-span-2">${player.name}</div>
                    
                    <div class="font-medium">Idade:</div>
                    <div class="col-span-2">${player.age} anos</div>
                    
                    <div class="font-medium">Time:</div>
                    <div class="col-span-2">${player.team}</div>
                    
                    <div class="font-medium">Status:</div>
                    <div class="col-span-2">
                        <span class="px-2 py-1 rounded-full text-sm ${statusClass}">${statusText}</span>
                    </div>
                </div>
                <div class="mt-4 flex justify-end">
                    <button id="edit-displayed-player" class="bg-blue-500 hover:bg-blue-600 text-white py-1 px-3 rounded text-sm ${isAdmin ? '' : 'hidden'}">
                        Editar Jogador
                    </button>
                </div>
            `;
            
            // Add event listener for edit button
            setTimeout(() => {
                const editButton = document.getElementById('edit-displayed-player');
                if (editButton) {
                    editButton.addEventListener('click', () => {
                        editPlayer(player.id);
                    });
                }
            }, 0);
            
            playerInfoDisplay.classList.remove('hidden');
        }
        
        // Register a new player with Firebase
        function registerPlayer(event) {
            event.preventDefault();
            
            const id = document.getElementById('playerId').value.trim();
            const name = document.getElementById('playerName').value.trim();
            const age = parseInt(document.getElementById('playerAge').value);
            const team = document.getElementById('playerTeam').value.trim();
            const status = document.getElementById('playerStatus').value;
            
            if (!id) {
                showNotification('Por favor, digite um ID para o jogador.');
                return;
            }
            
            // Create player object
            const player = { id, name, age, team, status };
            
            // Check if player already exists
            const existingPlayerIndex = playersDB.findIndex(p => p.id === id);
            const existingPlayer = existingPlayerIndex !== -1;
            
            // Save to Firebase
            firebase.database().ref('players/' + id).set(player)
                .then(() => {
                    showNotification(`Jogador "${name}" ${existingPlayer ? 'atualizado' : 'cadastrado'} com sucesso!`);
                    // Reset form
                    registerForm.reset();
                })
                .catch(error => {
                    console.error('Erro ao salvar jogador:', error);
                    showNotification('Erro ao salvar jogador. Tente novamente.');
                });
        }
        // Search players by name
        function searchPlayers() {
            const term = searchTerm.value.toLowerCase().trim();
            
            if (!term) {
                playersListDiv.innerHTML = '<p class="text-gray-500 italic">Digite um nome para buscar.</p>';
                resultsHeading.classList.add('hidden');
                return;
            }
            
            const results = playersDB.filter(player => 
                player.name.toLowerCase().includes(term)
            );
            
            if (results.length === 0) {
                playersListDiv.innerHTML = '<p class="text-gray-500 italic">Nenhum jogador encontrado.</p>';
            } else {
                let html = '';
                
                results.forEach(player => {
                    const statusClass = player.status === 'liberado' 
                        ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' 
                        : 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200';
                    
                    const statusText = player.status === 'liberado' ? 'Liberado para jogar' : 'Não liberado para jogar';
                    
                    html += `
                        <div class="bg-white dark:bg-gray-700 p-3 rounded shadow">
                            <div class="grid grid-cols-3 gap-1">
                                <div class="font-medium">Nome:</div>
                                <div class="col-span-2">${player.name}</div>
                                
                                <div class="font-medium">Idade:</div>
                                <div class="col-span-2">${player.age} anos</div>
                                
                                <div class="font-medium">Time:</div>
                                <div class="col-span-2">${player.team}</div>
                                
                                <div class="font-medium">Status:</div>
                                <div class="col-span-2">
                                    <span class="px-2 py-1 rounded-full text-sm ${statusClass}">${statusText}</span>
                                </div>
                            </div>
                            <div class="mt-3 flex justify-end space-x-2">
                                <button class="edit-player bg-blue-500 hover:bg-blue-600 text-white py-1 px-2 rounded text-sm ${isAdmin ? '' : 'hidden'}" 
                                    data-id="${player.id}">
                                    Editar
                                </button>
                                <button class="toggle-status 
                                    ${player.status === 'liberado' ? 'bg-red-500 hover:bg-red-600' : 'bg-green-500 hover:bg-green-600'} 
                                    text-white py-1 px-2 rounded text-sm ${isAdmin ? '' : 'hidden'}" 
                                    data-id="${player.id}">
                                    ${player.status === 'liberado' ? 'Bloquear' : 'Liberar'}
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                playersListDiv.innerHTML = html;
                
                // Add event listeners to edit buttons
                document.querySelectorAll('.edit-player').forEach(button => {
                    button.addEventListener('click', function() {
                        const id = this.getAttribute('data-id');
                        editPlayer(id);
                    });
                });
                
                // Add event listeners to toggle status buttons
                document.querySelectorAll('.toggle-status').forEach(button => {
                    button.addEventListener('click', function() {
                        const id = this.getAttribute('data-id');
                        togglePlayerStatus(id);
                    });
                });
            }
            
            resultsHeading.classList.remove('hidden');
        }
        
        // Edit player
        function editPlayer(id) {
            const player = playersDB.find(p => p.id === id);
            
            if (player) {
                // Fill form with player data
                document.getElementById('playerId').value = player.id;
                document.getElementById('playerName').value = player.name;
                document.getElementById('playerAge').value = player.age;
                document.getElementById('playerTeam').value = player.team;
                document.getElementById('playerStatus').value = player.status;
                
                // Switch to register tab
                switchTab('register');
            }
        }
        
        // Toggle player status with Firebase
        function togglePlayerStatus(id) {
            const playerIndex = playersDB.findIndex(p => p.id === id);
            
            if (playerIndex !== -1) {
                // Get current player
                const player = playersDB[playerIndex];
                
                // Toggle status
                const newStatus = player.status === 'liberado' ? 'bloqueado' : 'liberado';
                
                // Update in Firebase
                firebase.database().ref('players/' + id + '/status').set(newStatus)
                    .then(() => {
                        // Show notification
                        const statusText = newStatus === 'liberado' ? 'liberado' : 'bloqueado';
                        showNotification(`Status do jogador alterado para: ${statusText}`);
                        
                        // Local UI will be updated by the Firebase listener
                    })
                    .catch(error => {
                        console.error('Erro ao atualizar status:', error);
                        showNotification('Erro ao atualizar status. Tente novamente.');
                    });
            }
        }
        
        // Initialize app
        function init() {
            initializeDB();
            initializeFirebaseAuth();
            monitorConnection();
            
            // Check login status on startup
            checkLoginStatus();
            
            // Login form submission
            loginForm.addEventListener('submit', function(event) {
                event.preventDefault();
                
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                
                // Check credentials using Firebase
                attemptLogin(username, password)
                    .then(user => {
                        loginUser(user.username, user.isAdmin);
                        loginError.classList.add('hidden');
                    })
                    .catch(error => {
                        console.error('Erro de login:', error);
                        loginError.classList.remove('hidden');
                    });
            });
            
            // Logout button
            logoutButton.addEventListener('click', logoutUser);
            
            // Tab switching
            tabIdInput.addEventListener('click', () => switchTab('id-input'));
            tabRegister.addEventListener('click', () => switchTab('register'));
            tabSearch.addEventListener('click', () => switchTab('search'));
            
            // Camera controls
            startButton.addEventListener('click', startCamera);
            stopButton.addEventListener('click', stopCamera);
            
            // Check player
            checkPlayerButton.addEventListener('click', checkPlayer);
            playerIdInput.addEventListener('keyup', (e) => {
                if (e.key === 'Enter') {
                    checkPlayer();
                }
            });
            
            // Registration
            registerForm.addEventListener('submit', registerPlayer);
            
            // Search
            searchButton.addEventListener('click', searchPlayers);
            searchTerm.addEventListener('keyup', (e) => {
                if (e.key === 'Enter') {
                    searchPlayers();
                }
            });
            
            // Close notification
            closeNotification.addEventListener('click', hideNotification);
        }
        
        // Initialize when the document is fully loaded
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
